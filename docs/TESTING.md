# Sonic Explorers API Testing

[Go back to README.md](../README.md)

## User Story Testing

All user stories have been tested. The results can be found here: [User Story Tests](/docs/testing/userstory_test_results.md)

## Automated Testing

All Python code written for the project has been tested by writing automated unit tests using the testing features implemented in Django and Django Rest Framework ([Testing in Django](https://docs.djangoproject.com/en/4.2/topics/testing/), [Testing in DRF](https://www.django-rest-framework.org/api-guide/testing/)). Code coverage has been measured using [Coverage.py](https://coverage.readthedocs.io/en/latest/#). All crucial parts of the project have been covered by tests and a coverage of 97% of the code has been achieved (the remaining 3% are mostly due to untested model string representation methods).

<details>
<summary>Show detailed Coverage results</summary>
<img src="https://raw.githubusercontent.com/nacht-falter/sonic-explorers-api/main/docs/testing/sonic-explorers-api-coverage.png">
</details>

The output from running the tests in the terminal can be found here: [Test Results Python](/docs/testing/automated_testing_results.md)

## Manual Testing

- All API endpoints were manually tested with the browsable API interface provided by Django Rest Framework for development and with [Postman](https://www.postman.com/) for the deployed version (the documentation generated by Postman as a result of the performed tests can be found here: [Postman API documentation](https://documenter.getpostman.com/view/29756179/2s9YCBsopC)).
- The API is working as expected in both scenarios.

## PEP 8 Linter

All python code written for the project passes through the PEP 8 [python linter](https://pep8ci.herokuapp.com/) by Code Institute with no issues.


## Bugs

### Fixed Bugs

| Bug | Fix | Commit |
|---|---|---|
| There was a wrong indentation in the notification signal, which resulted in Django trying to create notifications whenever instances are saved, not only when they are created. | This was fixed by correcting the indentation to move the `create_notification` method inside the if statement. | [Commit](https://github.com/nacht-falter/sonic-explorers-api/commit/6b84f0c139a7ad60ef5d6bf7553ed4a8a8866278) |
| The `NotificationDetail` view erroneously inherited from the generic `RetrieveDestroy` view, so the `is_read` field could not be updated. |  The fix for this was to change the base view to `RetrieveUpdateDestroy` and change all field except for the `is_read` field to read-only in the `NotificationSerializer`. |  [Commit](https://github.com/nacht-falter/sonic-explorers-api/commit/86e2b60bd6f64acad6d0d87ecf63e5c21395fcd5) |
| There was a typo in the DRF `DATETIME_FORMAT` string, which broke all datetime values, which were not overridden by a serializer field. | Fixed the `DATETIME_FORMAT` string in `settings.py` | [Commit](https://github.com/nacht-falter/sonic-explorers-api/commit/69cd101d647ddb940ef37369fe5a927bbcb513d2) |
| After logging in with the `/api-auth/login/` endpoint, Django redirected to the default redirect URL `/accounts/profile/`, which does not exist. | This was fixed by setting `LOGIN_REDIRECT_URI` and `LOGOUT_REDIRECT_URI` to `/` | [Commit](https://github.com/nacht-falter/sonic-explorers-api/commit/06b978eedbdf9d30a8cce2e57b8c50fbddd0e391) |
| The detail view URLs had inconsistent trailing slashes, which lead to unpredictable behaviour of the API depending on if the trailing slash was inluded in the request or not. | This was fixed by removing all trailing slashes from the detail view URLs in order to achieve consistent behaviour for all endpoints. | [Commit 1](https://github.com/nacht-falter/sonic-explorers-api/commit/7cc63b7ce894aa0782ec1c524fa4dd065072bd22), [Commit 2](https://github.com/nacht-falter/sonic-explorers-api/commit/0f696061fcd9e938ace171d7f7fa8ca918d04117), [Commit 3](https://github.com/nacht-falter/sonic-explorers-api/commit/bc5f997928b311af5cae490402d1c932f53f4737), [Commit 4](https://github.com/nacht-falter/sonic-explorers-api/commit/548002b955cc6fd0c551d2793a8668753c8c4813) |

### Unfixed Bugs

- Trying to create a new sound instance including an audio file from the Django admin site raises a `500 Internal Server error`, probably due to the fact that the file upload is handled by the SoundSerializer which is not used by the admin site. I did not manage to fix this, but since the admin view will not be used for uploading sounds, this should not be a problem.

- Making an unauthenticated POST request to the `sounds/` endpoint on the deployed API will return a `503 Service Unavailable` error with a Heroku "Application Error" page instead of the expected `{"detail":"Authentication credentials were not provided."}%`. The Heroku logs show:

  ```
  2023-09-22T09:33:15.909815+00:00 heroku[router]: sock=backend at=error code=H18 desc="Server Request Interrupted" method=POST path="/sounds/" host=sonic-explorers-api-4c187c4cd99f.herokuapp.com request_id=e5b4011-148b-3ac0-2b02-a443272492a2 fwd="109.192.195.245" dyno=web.1 connect=0ms service=42ms status=503 bytes=384 protocol=https
  ```

  So far, no solution for this problem has been found, but since it does not affect the API's functionality, it has not been deemed necessary to further investigate the issue.

## Known limitations

- The browsable API interface provided by Django Rest Framework does not support lists with HTML input forms. For that reason the `TagField` on the Sound model does not work with the HTML form view. Requests including the `tags` field have to be sent with raw JSON data like this:

  ```
  {
    "tags": [
      "tag1",
      "tag2",
      "tag3"
    ]
  }
  ```

  Therefore new sound instances including tags can't be created from the Django admin site, either.
